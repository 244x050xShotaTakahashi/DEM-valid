# 安息角と摩擦係数の関係を調べる数値実験

## 概要

このディレクトリには、粒子の安息角と摩擦係数の関係を系統的に調べるための数値実験設定が含まれています。

DEMシミュレーションを用いて、摩擦係数を変化させたときの粒子堆積物の安息角を測定し、
理論予測（tan(θ) ≈ μ）との比較を行います。

## 実験設計

### 目的
- 摩擦係数を系統的に変化させ、堆積粒子の安息角を測定
- 摩擦係数と安息角の関係を定量的に評価
- 理論予測との比較による数値モデルの検証

### 測定方法
粒子を容器に落下させて堆積山を形成し、最終形状から左右の斜面角度を測定します。

### 実験パラメータ

#### 変化させるパラメータ
- **摩擦係数（粒子間・壁）**: 0.1, 0.2, 0.3, 0.4, 0.5, 0.6（6ケース）

#### 固定パラメータ
- **容器幅**: 0.3 m
- **粒子層数**: 22層
- **時間刻み**: 5.0×10⁻⁷ s
- **粒子半径**: 大粒子 1.0 cm、小粒子 0.5 cm
- **粒子密度**: 2480 kg/m³
- **ヤング率**: 粒子 4.9 GPa、壁 3.9 GPa
- **ポアソン比**: 粒子 0.23、壁 0.25
- **静止検出**: ON（STOP_WHEN_STATIC=1）
- **出力間隔**: 10000ステップ

## ファイル構成

```
inputs/friction_angle_study/
├── README.md                    # このファイル
├── input_friction_0.1.dat       # 摩擦係数 0.1 の入力ファイル
├── input_friction_0.2.dat       # 摩擦係数 0.2 の入力ファイル
├── input_friction_0.3.dat       # 摩擦係数 0.3 の入力ファイル
├── input_friction_0.4.dat       # 摩擦係数 0.4 の入力ファイル
├── input_friction_0.5.dat       # 摩擦係数 0.5 の入力ファイル
└── input_friction_0.6.dat       # 摩擦係数 0.6 の入力ファイル
```

## 実行方法

### 1. プログラムのビルド（初回のみ）

```bash
cd /home/b/b37581/DEM-valid
make clean
make
```

### 2. 全ケースの実行（推奨）

自動実行スクリプトを使用すると、6ケースを順次実行し、自動的に解析とグラフ作成まで行います。

```bash
./run_friction_study.sh
```

実行時間の目安: 各ケース10〜30分程度（計算機性能による）

### 3. 個別ケースの実行

特定の摩擦係数だけを実行する場合：

```bash
./build/dem_valid inputs/friction_angle_study/input_friction_0.3.dat
```

出力ファイルは `data/` ディレクトリに生成されます。

### 4. 安息角の測定

シミュレーション実行後、安息角測定スクリプトを実行：

```bash
python3 src/analyze_repose_angle.py \
    --data data/graph11.d \
    --output results/friction_0.3 \
    --name friction_0.3
```

### 5. 結果の統合

全ケースの結果を統合してグラフを作成：

```bash
python3 src/plot_friction_vs_angle.py \
    --input results/friction_study \
    --output results/friction_study/friction_study_summary.png
```

## 出力ファイル

### 個別ケースの出力（例: μ = 0.3）

```
results/friction_study/friction_0.3/
├── graph11.d                          # 粒子座標データ
├── graph21.d                          # 接触力データ
├── backl.d                            # バックアップデータ
├── friction_0.3_results.csv           # 測定結果（CSV）
├── friction_0.3_repose_angle.png      # 可視化プロット
└── animation_friction_0.3.gif         # アニメーション（オプション）
```

### 統合結果

```
results/friction_study/
├── all_results.csv                     # 全ケースの測定値
├── friction_study_summary.png          # 統合グラフ
└── summary.txt                         # サマリーテキスト
```

## 解析方法

### 安息角の測定アルゴリズム

1. **最終フレームの読み込み**: `data/graph11.d`から静止状態の粒子座標を取得
2. **表面粒子の検出**: 
   - 容器を左右に分割（中央20%は除外）
   - 各x位置での最も高い粒子を検出
3. **線形回帰**: 表面粒子に対して最小二乗法で直線をフィッティング
4. **安息角の計算**: 傾きから角度を計算（θ = arctan(|slope|)）
5. **左右の平均**: 左右斜面の安息角を平均して最終値とする

### 理論との比較

- **理論予測**: θ = arctan(μ)
- **線形性チェック**: tan(θ) vs μ のプロット（理論的には直線関係）
- **相対誤差**: (測定値 - 理論値) / 理論値 × 100 [%]

## 期待される結果

### 定性的な傾向
- 摩擦係数が大きいほど安息角が大きくなる
- 摩擦係数が小さいと粒子は流動的に振る舞い、安息角は小さい
- 摩擦係数が大きいと粒子は安定した急斜面を形成する

### 理論との関係
- 理想的には θ ≈ arctan(μ) の関係が成立
- 実際には粒子の形状効果、粒度分布、衝突エネルギー散逸などにより、
  理論値からのずれが生じる可能性がある

## トラブルシューティング

### シミュレーションが終了しない
- `MAX_CALCULATION_STEPS`を増やす
- `STOP_WHEN_STATIC`パラメータが正しく設定されているか確認

### 安息角の測定が失敗する
- 粒子数が少なすぎる場合: `PARTICLE_GEN_LAYERS`を増やす
- 容器幅が狭い場合: `CONTAINER_WIDTH`を大きくする
- 表面粒子の検出パラメータを調整（`analyze_repose_angle.py`内）

### メモリ不足エラー
- `src/dem_valid.f90`内の`ni_max`（最大粒子数）を確認
- 必要に応じて値を増やして再コンパイル

## 注意事項

1. **乱数シード**: 全ケースで同じシード（584287）を使用しているため、
   初期粒子配置は同一です。異なる配置で実験する場合は`RANDOM_SEED`を変更してください。

2. **計算時間**: 摩擦係数が大きいほど静止までに時間がかかる傾向があります。

3. **数値安定性**: 時間刻みが大きすぎると不安定になります。
   警告メッセージが出る場合は`TIME_STEP`を小さくしてください。

4. **並列実行**: 各ケースは独立しているため、複数の計算機で並列実行可能です。

## 参考文献

- Coulomb摩擦法則: F_friction ≤ μ × F_normal
- 安息角の理論: θ_repose ≈ arctan(μ)
- DEMシミュレーション: Cundall & Strack (1979)

## 更新履歴

- 2025-11-18: 初版作成



